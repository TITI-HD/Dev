name: WordPress CI/CD - Full Monitoring

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: '0 */3 * * *'     # Monitoring toutes les 3h
    - cron: '30 8 * * *'      # Rapport quotidien à 08h30
  workflow_dispatch:           # Lancement manuel possible

env:
  SITE_URL: "https://oupssecuretest.wordpress.com"
  BACKUP_DIR: "backups"
  RESTORE_DIR: "restored"
  ALERT_EMAIL: "danieltiti882@gmail.com"
  SMTP_SERVER: "smtp.gmail.com"
  SMTP_PORT: 587
  SMTP_USER: "danieltiti882@gmail.com"
  SMTP_PASS: ${{ secrets.SMTP_PASS }}
  MONITOR_DIR: "monitor_data"
  LOG_RETENTION_DAYS: "30"
  CHECK_INTERVAL_HOURS: "3"

jobs:
  monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || pip install requests schedule python-dateutil python-dotenv

      - name: Create necessary folders
        run: |
          mkdir -p ${{ env.MONITOR_DIR }}
          mkdir -p ${{ env.BACKUP_DIR }}
          mkdir -p ${{ env.RESTORE_DIR }}

      - name: Run WP Monitor
        run: |
          python monitor.py --once 2>&1 | tee ${{ env.MONITOR_DIR }}/last_run.log

      - name: Verify TXT report
        run: |
          if ls ${{ env.MONITOR_DIR }}/report_*.txt 1> /dev/null 2>&1; then
            echo "Rapport TXT généré ✅"
          else
            echo "ERREUR : rapport TXT non généré ❌"
            cat ${{ env.MONITOR_DIR }}/last_run.log
            exit 1
          fi

      - name: Upload monitoring artefacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artefacts
          path: |
            ${{ env.MONITOR_DIR }}/
            ${{ env.BACKUP_DIR }}/
            ${{ env.RESTORE_DIR }}/