name: WordPress CI/CD - Validation, Sauvegarde et Restauration

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 🐍 Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 📦 Installer les dépendances
        run: pip install -r requirements.txt
      
      - name: ✅ Vérifier import des modules
        run: |
          python -c "import monitor; print('✅ monitor importé')"
          python -c "import backup; print('✅ backup importé')"
          python -c "import restore; print('✅ restore importé')"
          echo "# 📊 Rapport CI/CD WordPress" > report.md
          echo "## ✅ Validation réussie" >> report.md

      - name: 📤 Sauvegarder le rapport provisoire
        uses: actions/upload-artifact@v4
        with:
          name: report-part
          path: report.md

  backup-test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      
      - name: 🐍 Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: 📦 Installer les dépendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 💾 Exécuter la sauvegarde WordPress
        run: python backup.py

      - name: 🔍 Vérifier les sauvegardes
        run: |
          echo "## 🔒 Rapport sauvegarde" > report.md
          if [ -d backups ] && [ "$(ls -A backups)" ]; then
            count=$(ls backups | wc -l)
            echo "- ✅ Sauvegarde réussie ($count fichiers)" >> report.md
            sha256sum backups/* | head -n 3 >> report.md
          else
            echo "❌ Aucune sauvegarde générée" >> report.md
            exit 1
          fi

      - name: 📤 Sauvegarder artefacts (backups)
        uses: actions/upload-artifact@v4
        with:
          name: wordpress-backups
          path: backups/

      - name: 📤 Sauvegarder rapport
        uses: actions/upload-artifact@v4
        with:
          name: report-part
          path: report.md

  restore-test:
    runs-on: ubuntu-latest
    needs: backup-test
    steps:
      - uses: actions/checkout@v4

      - name: 🐍 Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Installer les dépendances
        run: pip install -r requirements.txt

      - name: 📥 Télécharger sauvegardes
        uses: actions/download-artifact@v4
        with:
          name: wordpress-backups
          path: restored-backups

      - name: 🔍 Vérifier restauration
        run: |
          echo "## ♻️ Rapport restauration" > report.md
          if [ -d restored-backups ] && [ "$(ls -A restored-backups)" ]; then
            count=$(ls restored-backups | wc -l)
            echo "- ✅ Restauration OK ($count fichiers)" >> report.md
          else
            echo "❌ Restauration échouée" >> report.md
            exit 1
          fi

      - name: 🔄 Exécuter restauration
        run: python restore.py restored-backups

      - name: 📊 Publier rapport final
        uses: actions/upload-artifact@v4
        with:
          name: rapport-final
          path: report.md

      - name: 📢 Ajouter au résumé GitHub
        run: |
          echo "### 🚀 Rapport Final CI/CD" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY
