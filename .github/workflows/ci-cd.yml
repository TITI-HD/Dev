name: WordPress CI/CD - Validation, Sauvegarde et Restauration

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Installer les dÃ©pendances
        run: pip install -r requirements.txt
      
      - name: âœ… Valider les modules Python
        run: |
          python -c "import monitor; print('âœ… Module monitor importÃ© avec succÃ¨s')"
          python -c "import backup; print('âœ… Module backup importÃ© avec succÃ¨s')"
          python -c "import app; print('âœ… Module app importÃ© avec succÃ¨s')"
          python -c "import restore; print('âœ… Module restore importÃ© avec succÃ¨s')"
          echo "# ðŸ“Š Rapport CI/CD WordPress" > report.md
          echo "## âœ… Validation" >> report.md
          echo "- Tous les modules Python ont Ã©tÃ© importÃ©s avec succÃ¨s." >> report.md

      - name: ðŸ“¤ Sauvegarder le rapport provisoire
        uses: actions/upload-artifact@v4
        with:
          name: report-part
          path: report.md

  backup-test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: ðŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ’¾ ExÃ©cuter le script de sauvegarde
        run: python backup.py

      - name: ðŸ” VÃ©rifier les fichiers de sauvegarde
        run: |
          count=$(ls backups/ | wc -l)
          if [ "$count" -gt 0 ]; then
            echo "- âœ… Sauvegarde rÃ©ussie ($count fichiers)" >> report.md
            echo "- Hash: $(sha256sum backups/* | head -n 1 | cut -d ' ' -f1)" >> report.md
          else
            echo "âŒ Ã‰chec du test de sauvegarde" >> report.md
            exit 1
          fi

      - name: ðŸ§ª Lancer les tests unitaires
        run: python -m unittest discover -s . -p "test_*.py"

      - name: ðŸ“¤ Sauvegarder artefacts
        uses: actions/upload-artifact@v4
        with:
          name: wordpress-backups
          path: backups/

      - name: ðŸ“¤ Sauvegarder rapport partiel
        uses: actions/upload-artifact@v4
        with:
          name: report-part
          path: report.md

  restore-test:
    runs-on: ubuntu-latest
    needs: backup-test
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: pip install -r requirements.txt

      - name: ðŸ“¥ TÃ©lÃ©charger les artefacts (backups)
        uses: actions/download-artifact@v4
        with:
          name: wordpress-backups
          path: restored-backups

      - name: ðŸ” VÃ©rifier les fichiers restaurÃ©s
        run: |
          count=$(ls restored-backups/ | wc -l)
          if [ "$count" -gt 0 ]; then
            echo "- âœ… Restauration rÃ©ussie ($count fichiers)" >> report.md
          else
            echo "âŒ Aucun fichier restaurÃ©" >> report.md
            exit 1
          fi

      - name: ðŸ”„ ExÃ©cuter le script de restauration
        run: python restore.py restored-backups

      - name: ðŸ“Š Attacher rapport final combinÃ©
        uses: actions/upload-artifact@v4
        with:
          name: rapport-final
          path: report.md

      - name: ðŸ“¢ Publier rapport dans Summary GitHub
        run: |
          echo "### ðŸš€ Rapport Final CI/CD" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY

      