name: WordPress CI/CD - Backup & Restore

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: '0 */3 * * *'   # Surveillance toutes les 3h
    - cron: '0 8 * * *'     # Rapport quotidien à 08:00
  workflow_dispatch:        # Permet lancement manuel

env:
  SITE_URL: "https://oupssecuretest.wordpress.com"
  BACKUP_DIR: "sauvegardes"
  RESTORE_DIR: "restaurations"
  ALERT_EMAIL: "danieltiti882@gmail.com"
  SMTP_SERVER: "smtp.gmail.com"
  SMTP_PORT: 587
  SMTP_USER: "danieltiti882@gmail.com"
  SMTP_PASS: ${{ secrets.SMTP_PASS }}

jobs:
  wordpress-backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Create directories
        run: |
          mkdir -p $BACKUP_DIR
          mkdir -p $RESTORE_DIR
          mkdir -p workflow-logs

      - name: Debug - List files
        run: |
          pwd
          ls -R

      - name: Run backup script
        run: |
          source .venv/bin/activate
          # Adapte le chemin ici si nécessaire
          if python wp-backup-restore.py fetch --site-url "$SITE_URL" --backup-dir "$BACKUP_DIR"; then
            echo "<li style='color:green;'>Sauvegarde OK</li>" >> workflow-logs/logs.html
          else
            echo "<li style='color:red;'>ERREUR Sauvegarde</li>" >> workflow-logs/logs.html
            exit 1
          fi

      - name: Send notification email
        if: failure()
        run: |
          source .venv/bin/activate
          python send_alert_email.py \
            --to "$ALERT_EMAIL" \
            --subject "Échec sauvegarde WordPress" \
            --smtp-server "$SMTP_SERVER" \
            --smtp-port "$SMTP_PORT" \
            --smtp-user "$SMTP_USER" \
            --smtp-pass "$SMTP_PASS"

  wordpress-restore:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Restore backup
        run: |
          python -m venv .venv
          source .venv/bin/activate
          mkdir -p $RESTORE_DIR
          # Adapte le nom du script ici aussi
          python wp-backup-restore.py fetch --url="$SITE_URL" --source="$BACKUP_DIR"
          python wp-backup-restore.py restore --dir="$RESTORE_DIR"
