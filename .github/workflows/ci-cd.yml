name: üîç Surveillance WordPress.com - Notifications WhatsApp

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• R√©cup√©ration du d√©p√¥t
        uses: actions/checkout@v3

      - name: üêç Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: üì¶ Installer les d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install requests twilio python-dotenv

      - name: üöÄ Ex√©cuter le script de surveillance
        env:
          # Configuration SMTP CORRIG√âE
          SITE_URL: https://oupssecuretest.wordpress.com
          ALERT_EMAIL: danieltiti882@gmail.com
          SMTP_SERVER: smtp.gmail.com
          SMTP_PORT: 587
          # Syntaxe CORRIG√âE : ${{ secrets.X }} au lieu de $(( secrets.X ))
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}
        run: python monitor.py

      - name: üì± Envoyer notification WhatsApp si √©chec
        if: failure()
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}
        run: |
          python -c "
import os
from twilio.rest import Client

account_sid = os.getenv('TWILIO_ACCOUNT_SID')
auth_token = os.getenv('TWILIO_AUTH_TOKEN')
twilio_from = os.getenv('TWILIO_WHATSAPP_FROM')
twilio_to = os.getenv('TWILIO_WHATSAPP_TO')

if account_sid and auth_token and twilio_from and twilio_to:
    client = Client(account_sid, auth_token)
    message = client.messages.create(
        from_=f'whatsapp:{twilio_from}',
        body='‚ùå Surveillance WordPress √âCHEC - Le script monitor.py a √©chou√©. V√©rifiez GitHub Actions.',
        to=f'whatsapp:{twilio_to}'
    )
    print('Notification WhatsApp envoy√©e')
else:
    print('Configuration Twilio manquante')
"

  security-scan:
    runs-on: ubuntu-latest
    needs: monitor
    if: always()

    steps:
      - name: üì• R√©cup√©ration du d√©p√¥t
        uses: actions/checkout@v3

      - name: üêç Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: üì¶ Installer d√©pendances s√©curit√©
        run: pip install requests beautifulsoup4

      - name: üîç Ex√©cuter scan de s√©curit√©
        run: python security_monitor.py --scan
        env:
          SITE_URL: https://oupssecuretest.wordpress.com
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}