name: WordPress CI/CD - Validation, Sauvegarde et Restauration

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Installer les dÃ©pendances
        run: pip install -r requirements.txt
      
      - name: âœ… VÃ©rifier import des modules
        run: |
          python -c "import monitor; print('âœ… monitor importÃ©')"
          python -c "import backup; print('âœ… backup importÃ©')"
          python -c "import restore; print('âœ… restore importÃ©')"
          echo "# ðŸ“Š Rapport CI/CD WordPress" > report.md
          echo "## âœ… Validation rÃ©ussie" >> report.md

      - name: ðŸ“¤ Sauvegarder le rapport provisoire
        uses: actions/upload-artifact@v4
        with:
          name: report-part
          path: report.md

  backup-test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: ðŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ’¾ ExÃ©cuter la sauvegarde WordPress
        run: python backup.py

      - name: ðŸ” VÃ©rifier les sauvegardes
        run: |
          echo "## ðŸ”’ Rapport sauvegarde" > report.md
          if [ -d backups ] && [ "$(ls -A backups)" ]; then
            count=$(ls backups | wc -l)
            echo "- âœ… Sauvegarde rÃ©ussie ($count fichiers)" >> report.md
            sha256sum backups/* | head -n 3 >> report.md
          else
            echo "âŒ Aucune sauvegarde gÃ©nÃ©rÃ©e" >> report.md
            exit 1
          fi

      - name: ðŸ“¤ Sauvegarder artefacts (backups)
        uses: actions/upload-artifact@v4
        with:
          name: wordpress-backups
          path: backups/

      - name: ðŸ“¤ Sauvegarder rapport
        uses: actions/upload-artifact@v4
        with:
          name: report-part
          path: report.md

  restore-test:
    runs-on: ubuntu-latest
    needs: backup-test
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: pip install -r requirements.txt

      - name: ðŸ“¥ TÃ©lÃ©charger sauvegardes
        uses: actions/download-artifact@v4
        with:
          name: wordpress-backups
          path: restored-backups

      - name: ðŸ” VÃ©rifier restauration
        run: |
          echo "## â™»ï¸ Rapport restauration" > report.md
          if [ -d restored-backups ] && [ "$(ls -A restored-backups)" ]; then
            count=$(ls restored-backups | wc -l)
            echo "- âœ… Restauration OK ($count fichiers)" >> report.md
          else
            echo "âŒ Restauration Ã©chouÃ©e" >> report.md
            exit 1
          fi

      - name: ðŸ”„ ExÃ©cuter restauration
        run: python restore.py restored-backups

      - name: ðŸ“Š Publier rapport final
        uses: actions/upload-artifact@v4
        with:
          name: rapport-final
          path: report.md

      - name: ðŸ“¢ Ajouter au rÃ©sumÃ© GitHub
        run: |
          echo "### ðŸš€ Rapport Final CI/CD" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY
