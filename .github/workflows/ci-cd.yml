name: üîç Surveillance WordPress.com

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: üì• R√©cup√©ration du d√©p√¥t
        uses: actions/checkout@v3

      - name: üêç Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: üì¶ Installer les d√©pendances
        run: pip install requests

      - name: üöÄ Ex√©cuter le script de surveillance
        env:
          # URL du site √† surveiller
          SITE_URL: https://oupssecuretest.wordpress.com
          # Email qui recevra l'alerte (peut rester en clair)
          ALERT_EMAIL: danieltiti882@gmail.com
          # Configuration SMTP pour Gmail
          SMTP_SERVER: smtp.gmail.com
          SMTP_PORT: 587
          # Les identifiants SMTP DOIVENT √™tre des secrets GitHub
          # SMTP_USER est probablement le m√™me que ALERT_EMAIL
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
        run: python monitor.pyname: üîç Surveillance WordPress.com - Notifications WhatsApp

on:
  schedule:
    - cron: "*/30 * * * *"  # Toutes les 30 minutes
  workflow_dispatch:         # D√©clenchement manuel
  push:
    branches: [ main ]       # D√©clench√© sur push
  pull_request:
    branches: [ main ]       # D√©clench√© sur PR

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10      # Timeout pour √©viter les executions infinies

    steps:
      - name: üì• R√©cup√©ration du d√©p√¥t
        uses: actions/checkout@v3

      - name: üêç Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'       # Cache pour acc√©l√©rer les installations

      - name: üì¶ Installer les d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install requests twilio python-dotenv

      - name: üîê Charger les variables d'environnement
        run: |
          echo "SITE_URL=https://oupssecuretest.wordpress.com" >> $GITHUB_ENV
          echo "ALERT_EMAIL=danieltiti882@gmail.com" >> $GITHUB_ENV
          echo "SMTP_SERVER=smtp.gmail.com" >> $GITHUB_ENV
          echo "SMTP_PORT=587" >> $GITHUB_ENV

      - name: üöÄ Ex√©cuter le script de surveillance
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}
        run: python monitor.py

      - name: üì± Envoyer notification WhatsApp si √©chec
        if: failure()        # Seulement en cas d'√©chec
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}
        run: |
          python -c "
import os
from twilio.rest import Client

account_sid = os.getenv('TWILIO_ACCOUNT_SID')
auth_token = os.getenv('TWILIO_AUTH_TOKEN')
twilio_from = os.getenv('TWILIO_WHATSAPP_FROM')
twilio_to = os.getenv('TWILIO_WHATSAPP_TO')

if all([account_sid, auth_token, twilio_from, twilio_to]):
    client = Client(account_sid, auth_token)
    message = client.messages.create(
        from_=f'whatsapp:{twilio_from}',
        body='‚ùå Surveillance WordPress √âCHEC - Le script monitor.py a √©chou√©. V√©rifiez GitHub Actions.',
        to=f'whatsapp:{twilio_to}'
    )
    print('Notification WhatsApp envoy√©e')
else:
    print('Configuration Twilio manquante')
"

  security-scan:
    runs-on: ubuntu-latest
    needs: monitor           # S'ex√©cute apr√®s le monitoring
    if: always()             # Toujours ex√©cuter m√™me si monitor √©choue

    steps:
      - name: üì• R√©cup√©ration du d√©p√¥t
        uses: actions/checkout@v3

      - name: üêç Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: üì¶ Installer d√©pendances s√©curit√©
        run: pip install requests beautifulsoup4

      - name: üîç Ex√©cuter scan de s√©curit√©
        run: python security_monitor.py --scan
        env:
          SITE_URL: https://oupssecuretest.wordpress.com
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO: ${{ secrets.TWILIO_WHATSAPP_TO }}